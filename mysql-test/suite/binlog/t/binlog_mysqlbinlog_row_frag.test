--source include/have_debug.inc
--source include/have_log_bin.inc
--source include/have_binlog_format_row.inc

--let $MYSQLD_DATADIR= `select @@datadir`
--let $max_size=1024

CREATE TABLE t (a TEXT);
# events of interest are guaranteed to stay in 000001 log
RESET MASTER;
--eval INSERT INTO t SET a=repeat('a', $max_size)
SELECT a from t into @a;
FLUSH LOGS;
DELETE FROM t;

--exec $MYSQL_BINLOG --debug-binlog-row-event-max-encoded-size=256 $MYSQLD_DATADIR/master-bin.000001 > $MYSQLTEST_VARDIR/tmp/mysqlbinlog.sql

--exec $MYSQL test < $MYSQLTEST_VARDIR/tmp/mysqlbinlog.sql

SELECT a LIKE @a as 'true' FROM t;
SELECT @binlog_fragment_0, @binlog_fragment_1 as 'NULL';

# improper syntax error
--echo BINLOG number-of-fragments must be exactly two
--error ER_PARSE_ERROR
BINLOG DEFRAGMENT(@binlog_fragment);
--error ER_PARSE_ERROR
BINLOG DEFRAGMENT(@binlog_fragment, @binlog_fragment, @binlog_fragment);

# corrupted fragments error check (to the expected error code notice,
# the same error code occurs in a similar unfragmented case)
SET @binlog_fragment_0='012345';
SET @binlog_fragment_1='012345';
--error ER_SYNTAX_ERROR
BINLOG DEFRAGMENT(@binlog_fragment_0, @binlog_fragment_1);

# Not existing fragment is not allowed
SET @binlog_fragment_0='012345';
--error ER_BASE64_DECODE_ERROR
BINLOG DEFRAGMENT(@binlog_fragment_0, @binlog_fragment_not_exist);

--echo # Cleanup
DROP TABLE t;
